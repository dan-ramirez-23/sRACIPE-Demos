---
title: "Regulation Comparison for Coupled Toggle Switch and Repressilator"
author: "Aidan Tillman"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(sRACIPE)
library(ggplot2)
library(tidyr)
library(dplyr)
```

## Introduction

```{r message=FALSE, warning=FALSE}
coupledRepTS_tf <- read.table(file.path("../topos",paste0("TS_rep_2",".tpo")), header=T)
coupledRepTS_pd <- read.table(file.path("../topos",paste0("TS_rep_2_pd",".tpo")), header=T)
```

## Estimating Proper Runtime

```{r message=FALSE, warning=FALSE}
coupledTFSet <- sracipeSimulate(circuit = coupledRepTS_tf, numModels = 100, nIC = 5,
                             numConvergenceIter = 100, limitcycles = TRUE)
coupledPDSet <- sracipeSimulate(circuit = coupledRepTS_tf, numModels = 100, nIC = 5,
                             numConvergenceIter = 100, foldChangeMaxDeg = 100,
                             limitcycles = TRUE)
```

```{r}
coupledTFSet <- sracipeConvergeDist(coupledTFSet)
coupledPDSet <- sracipeConvergeDist(coupledPDSet)
```


## Running full simulation



```{r eval=FALSE}
coupledTFSet <- sracipeSimulate(circuit = coupledRepTS_tf, numModels = 1000, nIC = 150,
                                limitcycles = TRUE, numConvergenceIter = 50, 
                                integrateStepSize = 0.02, maxLCs = 1, 
                                foldChangeMin = 1, foldChangeMax = 100)
coupledPDSet <- sracipeSimulate(circuit = coupledRepTS_pd, numModels = 1000, nIC = 150,
                                limitcycles = TRUE, numConvergenceIter = 60, 
                                integrateStepSize = 0.02, maxLCs = 1, 
                                foldChangeMinDeg = 1, foldChangeMaxDeg = 10)
```

```{r}
load(file.path("../regCompData",paste0("coupledTSRep_tf",".RDA")))
load(file.path("../regCompData",paste0("coupledTSRep_pd",".RDA")))
```

```{r}
coupledTFSet <- sracipeConvergeDist(coupledTFSet)
coupledPDSet <- sracipeConvergeDist(coupledPDSet)
```


## Comparison of Dynamical Mode distributions


```{r}
coupled_tfStateCounts <- coupledTFSet@metadata[["uniqueStateCounts"]][["UniqueStableStateNo"]]
coupled_pdStateCounts <- coupledPDSet@metadata[["uniqueStateCounts"]][["UniqueStableStateNo"]]
```

```{r}
LC_tf <- metadata(coupledTFSet)$LCData
LC_pd <- metadata(coupledPDSet)$LCData

tf_LCbool <- integer(1000)
tf_LCbool[LC_tf[[1]]] <- 1

pd_LCbool <- integer(1000)
pd_LCbool[LC_pd[[1]]] <- 1

```


```{r echo=FALSE}


state_pd_plot <- data.frame(
  setup= "PD",
  stateCount = coupled_pdStateCounts,
  group = pd_LCbool
)
state_tf_plot <- data.frame(
    setup= "TF",
    stateCount = coupled_tfStateCounts,
  group = tf_LCbool
)

state_plot <- bind_rows(state_pd_plot, state_tf_plot)

state_plot <- state_plot %>% filter(stateCount %in% 0:2)

state_summary <- state_plot %>%
  group_by(setup, group, stateCount) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(setup) %>%
  mutate(prop = count / sum(count))

plot_group <- function(g) {
  ggplot(dplyr::filter(state_summary, group == g),
         aes(x = factor(stateCount), y = prop, fill = setup)) +
    geom_col(position = "dodge") +
    scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
    labs(
      x = "State Count",
      y = "Proportion",
      fill = "Setup",
      title = paste("Group", g)
    ) +
    theme_minimal()  +
    theme(
      axis.text.x = element_text(size = 16),
      axis.text.y = element_text(size = 16, face="bold"),
      axis.title = element_text(size = 16))
}

plot_group0 <- plot_group(0)
plot_group1 <- plot_group(1)

# Example: print them
print(plot_group0)
print(plot_group1)

```

## Comparison of State distributions

```{r}
coupled_tf_SS <- sracipeUniqueStates(coupledTFSet)
coupled_pd_SS <- sracipeUniqueStates(coupledPDSet)
```


```{r}
coupled_tf_SS <- Filter(function(x) nrow(x) > 0 && ncol(x) > 0, coupled_tf_SS)
coupled_tf_SS <- t(do.call(cbind, coupled_tf_SS))

coupled_pd_SS <- Filter(function(x) nrow(x) > 0 && ncol(x) > 0, coupled_pd_SS)
coupled_pd_SS <- t(do.call(cbind, coupled_pd_SS))
```

```{r}

tmpMeans <- rowMeans(t(log2(1+coupled_tf_SS)))
tmpSds <- apply(t(log2(1+coupled_tf_SS)),1,sd)
tf_SS_norm <- log2(1+coupled_tf_SS)
tf_SS_norm <- sweep(tf_SS_norm, 2, tmpMeans, FUN = "-") # scale
tf_SS_norm <- sweep(tf_SS_norm, 2, tmpSds, FUN = "/") # scale

pd_SS_norm <- log2(1+coupled_pd_SS) # Log transform
pd_SS_norm <- sweep(pd_SS_norm, 2, tmpMeans, FUN = "-") # scale
pd_SS_norm <- sweep(pd_SS_norm, 2, tmpSds, FUN = "/") # scale

```

Next, PCA is performed on the TF data, and we continue to project the PD data into the PCA space for the TF data.

```{r}
pca_tf <- prcomp(tf_SS_norm)
pca_pd <- scale(pd_SS_norm, pca_tf$center, pca_tf$scale) %*% pca_tf$rotation

```


```{r}

k_use <- 2
dist_mat_tf <- dist(pca_tf$x)
hc_tf <- hclust(dist_mat_tf, method = "ward.D2")
cluster_labels_tf <- cutree(hc_tf, k = k_use)

dist_mat_pd <- dist(pca_pd)
hc_pd <- hclust(dist_mat_pd, method = "ward.D2")
cluster_labels_pd <- cutree(hc_pd, k = k_use)

```


The last step is plot the results of the clustering as projected onto the same PCA space. This gives a clear visualization of how the distribution changes shape between distribution types.

```{r echo=FALSE}
pc1_weight <- round(100*summary(pca_tf)$importance[2,1],2)
pc2_weight <- round(100*summary(pca_tf)$importance[2,2],2)
plot_xlab <- paste("PC1 (",pc1_weight,"%)",sep="")
plot_ylab <- paste("PC2 (",pc2_weight,"%)",sep="")

image_tf <- ggplot(pca_tf$x, aes(x=PC1, y=PC2, color=as.factor(cluster_labels_tf))) +
  geom_point(size=2) +
  scale_color_manual(values=c("blue", "red")) +
  xlab(plot_xlab) +
  ylab(plot_ylab) +
  xlim(-4,4) +
  ylim(-6,3) +
  labs(color="Cluster") + 
  ggtitle("Coupled Toggle Repressilator TF") +
  theme(axis.line = element_line(linewidth = 1, color = "black"), 
        axis.ticks = element_line(linewidth = 1, color="black"),
        panel.background = element_rect("white"),
        plot.background = element_rect("white"),
        axis.title = element_text(size=28),
        axis.text = element_text(size=24),
        legend.title = element_text(size=18),
        legend.text = element_text(size=14),
        plot.title = element_text(size = 22, hjust = 0.5))
image_tf


image_pd <- ggplot(pca_pd, aes(x=PC1, y=PC2, color=as.factor(cluster_labels_pd))) +
  geom_point(size=2) +
  scale_color_manual(values=c("blue", "red")) +
  xlab(plot_xlab) +
  ylab(plot_ylab) +
  xlim(-4,4) +
  ylim(-6,3) +
  labs(color="Cluster") + 
  ggtitle("Coupled Toggle Repressilator PD") +
  theme(axis.line = element_line(linewidth = 1, color = "black"), 
        axis.ticks = element_line(linewidth = 1, color="black"),
        panel.background = element_rect("white"),
        plot.background = element_rect("white"),
        axis.title = element_text(size=28),
        axis.text = element_text(size=24),
        legend.title = element_text(size=18),
        legend.text = element_text(size=14),
        plot.title = element_text(size = 22, hjust = 0.5))
image_pd
```

## Comparison of Limit Cycle Properties

```{r}

pd_periods <- LC_pd %>%
  distinct(model = LC_pd[[1]], period = LC_pd[[3]]) %>%
  pull(period)
tf_periods <- LC_tf %>%
  distinct(model = LC_tf[[1]], period = LC_tf[[3]]) %>%
  pull(period)

pdMeanPeriod <- mean(pd_periods)*0.01
tfMeanPeriod <- mean(tf_periods)*0.01

pdSTDPeriod <- sd(pd_periods)*0.01
tfSTDPeriod <- sd(tf_periods)*0.01

stats_cc <- data.frame(
  group = c("PD Model", "TF Model"),
  mean  = c(pdMeanPeriod, tfMeanPeriod),
  sd    = c(pdSTDPeriod, tfSTDPeriod)
)

image_period <- ggplot(stats_cc, aes(x = group, y = mean)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.2) +
  ylab("Period (Unit Time)") +
  ylim(0,30) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 14, face="bold"))

image_period
```

