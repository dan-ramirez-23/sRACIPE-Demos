---
title: "Clamping Demo"
author: "Dan Ramirez"
date: "2025-08-27"
output: html_document
---

```{r doc_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

```{r sim_setup, echo = T, results = 'hide', warning=FALSE, message=FALSE}
rm(list=ls())
#remotes::install_github("lusystemsbio/sRACIPE")
library(sRACIPE)                 # GRN simulation
library(ggplot2)                 # plotting
library(microbenchmark)          # time cost benchmarking
library(dplyr)                   # data management
library(tidyr)                   # data management
library(ComplexHeatmap)          # plotting
# seed for reproducibility & color palette for plots
set.seed(1234)
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")[c(3,2,4:8)]

nModels <- 1000
nICs <- 100
n_places_rounded <- 4

topo_name <- "toggleSwitch"

topoDir <- file.path(getwd(),topo_name)
plotDir <- file.path(topoDir,"plots")
dataDir <- file.path(topoDir,"data")

if(!dir.exists(topoDir)) {
  dir.create(topoDir)
}
if(!dir.exists(dataDir)) {
  dir.create(dataDir)
}
if(!dir.exists(plotDir)) {
  dir.create(plotDir)
}

topo <- read.table(file.path("topos",paste0(topo_name,".tpo")), header=T)


```

## Initial Simulation, PCA & Clustering

```{r initial_sims}

racipe_fname <- file.path(dataDir,"racipe.Rds")
if(!file.exists(racipe_fname)) {
  racipe <- sracipeSimulate(topo, numModels = nModels, nIC = nICs)
  saveRDS(racipe, racipe_fname)
} else {
  racipe <- readRDS(racipe_fname)
}

## GET UNIQUE STEADY STATES
ss_unique_fname <- file.path(dataDir,"ss_unique.Rds")
racipe_summary_fname <- file.path(dataDir,"racipe_summary.Rds")
if(!file.exists(ss_unique_fname)) {
  states <- round(as.data.frame(t(assay(racipe))), n_places_rounded)
  states$Model <- rep(1:nModels, each=nICs)
  ss_unique <- states %>%
    group_by(Model) %>%
    distinct(across(-Model), .keep_all = TRUE) %>%
    mutate(State = row_number()) %>%
    ungroup()

  racipe_summary_df <- ss_unique %>%
    group_by(Model) %>%
    summarise(NumStates = n(), .groups = "drop")

  saveRDS(ss_unique, ss_unique_fname)
  saveRDS(racipe_summary_df, racipe_summary_fname)
} else {
  ss_unique <- readRDS(ss_unique_fname)
  racipe_summary_df <- readRDS(racipe_summary_fname)
}

genes <- rownames(racipe)
expr_mat <- ss_unique[,genes]
tmpMeans <- rowMeans(t(log2(1+expr_mat)))
tmpSds <- apply(t(log2(1+expr_mat)),1,sd)
expr_mat_norm <- log2(1+expr_mat)
expr_mat_norm[,genes] <- sweep(expr_mat_norm[,genes], 2, tmpMeans, FUN = "-") # scale
expr_mat_norm[,genes] <- sweep(expr_mat_norm[,genes], 2, tmpSds, FUN = "/") # scale

## PCA
pca_fname <- file.path(dataDir,"pca.Rds")
if(!file.exists(pca_fname)) {

  pca <- prcomp(expr_mat_norm[,genes])

  saveRDS(pca, pca_fname)
} else {
  pca <- readRDS(pca_fname)
}

## CLUSTERING
clust_fname <- file.path(dataDir,"cluster_labels.Rds")
if(!file.exists(clust_fname)) {
  k_use <- k_list[topo_name]
  pca_data <- pca$x
  dist_mat <- dist(pca_data)
  hc <- hclust(dist_mat, method = "ward.D2")
  cluster_labels <- cutree(hc, k = k_use)
  saveRDS(cluster_labels, clust_fname)
} else {
  cluster_labels <- readRDS(clust_fname)
}


```

## PCA plot of simulated steady states

```{r eda_plots, echo=TRUE}
## PLOTS
# PCA
pc1_weight <- round(100*summary(pca)$importance[2,1],2)
pc2_weight <- round(100*summary(pca)$importance[2,2],2)
plot_xlab <- paste("PC1 (",pc1_weight,"%)",sep="")
plot_ylab <- paste("PC2 (",pc2_weight,"%)",sep="")

ggplot(pca$x, aes(x=PC1, y=PC2, color=as.factor(cluster_labels))) +
  geom_point(size=2) +
  scale_color_manual(values=cbPalette) +
  xlab(plot_xlab) +
  ylab(plot_ylab) +
  labs(color="Cluster") +
  theme(axis.line = element_line(linewidth = 1, color = "black"), 
        axis.ticks = element_line(linewidth = 1, color="black"),
        panel.background = element_rect("white"),
        plot.background = element_rect("white"),
        axis.title = element_text(size=28),
        axis.text = element_text(size=24),
        legend.title = element_text(size=18),
        legend.text = element_text(size=14))


# Heatmap
ha_df <- data.frame(Cluster=cluster_labels)

# Create an annotation object for the columns
column_annotation <- HeatmapAnnotation(df = ha_df, 
                                       col=list(Cluster=c("1"=unname(cbPalette[1]),"2"=unname(cbPalette[2]),
                                                          "3"=unname(cbPalette[3]),"4"=unname(cbPalette[4]))))
# Create the heatmap with annotation
image <- Heatmap(as.matrix(t(expr_mat_norm)), 
                 name = "Expression", 
                 top_annotation = column_annotation,
                 row_names_gp=gpar(fontsize=12),
                 clustering_method_columns = "ward.D2",
                 show_column_names = F)
image
  

```

## Clamping-based transition simulations

We will try to drive bistable models from cluster 1 to cluster 2 by clamping gene B at the target levels. We will simulate the bistable models with paired initializations in each cluster, then clamp B expression values to the target cluster levels until models converge. Next, we will remove the clamps and simulate until convergence again to allow the system to relax. This transient signal should drive models from cluster 1 to cluster 2. 

### Identify bistable models
```{r clamping_id_bistable}
##### IDENTIFY BISTABLE MODELS #####
# def: bistable models are those with multiple steady states across different clusters
ss_unique$Cluster <- cluster_labels
ss_unique <- as.data.frame(ss_unique)
racipe_summary_df$Stability <- NA
for(model in racipe_summary_df$Model) {
  numModelClusters <- length(unique(ss_unique[which(ss_unique$Model == model),"Cluster"]))
  if(numModelClusters == 2) {
    racipe_summary_df[which(racipe_summary_df$Model == model), "Stability"] <- "Bistable"
  }
}
bistable_models <- which(racipe_summary_df$Stability == "Bistable" & racipe_summary_df$NumStates == 2)
```

### Simulate transitions with clamps in place

```{r clamp_sims}
##### CLAMPING-DRIVEN TRANSITIONS #####
## Subset bistable models & simulate transitions between clusters by clamping gene values
keepIdx <- c()
for(model in bistable_models) {
  # add steady states for cluster 1 and 2
  addIdx <- which(ss_unique$Model == model)
  keepIdx <- c(keepIdx, addIdx)
  
}
clamp_df <- tidyr::pivot_longer(ss_unique[keepIdx,], cols = all_of(genes),
                         names_to = "Gene", values_to = "Expression")
clamp_df$ModelIndex <- as.numeric(factor(clamp_df$Model))

# set up racipe object with params & ICs from bistable models (paired initialization)
racipe_bistable <- sracipeSimulate(topo, numModels = (2*length(bistable_models)), nIC = 1,
                                   genIC = T, genParams = T, integrate = F)
sracipeIC(racipe_bistable) <- t(ss_unique[keepIdx,genes])
sracipeParams(racipe_bistable) <- sracipeParams(racipe)[rep(bistable_models, each=2),]

# clamp B to drive toward cluster 2 values
clamp_df_filt_A <- clamp_df[which(clamp_df$Cluster == 2 & clamp_df$Gene == "A"),]
clamp_df_filt_B <- clamp_df[which(clamp_df$Cluster == 2 & clamp_df$Gene == "B"),]
clamp_df_use <- data.frame(B=rep(clamp_df_filt_B$Expression, each=2))

# simulate with clamping
racipe_clamped <- sracipeSimulate(racipe_bistable, integrate=T, genIC = F, genParams = F,
                                  geneClamping = clamp_df_use, numModels = 326, nIC = 1, stepper = "EM",
                                  initialNoise = 0.2, scaledNoise = T, nNoise = 1, simDet = F)
```


### Relaxation simulations with clamps removed
```{r clamp_relax_sims}
racipe_clamp_relax <- racipe_clamped
sracipeIC(racipe_clamp_relax) <- assay(racipe_clamped)
racipe_clamp_relax <- sracipeSimulate(racipe_clamp_relax, integrate=T, genIC=F, genParams = F,
                                      numModels = 326, nIC=1, stepper = "EM", initialNoise = 0, nNoise = 0, simDet = T)

```


### Plot results of clamping simulation

As the plot shows, most of the bistable models transitioned from their cluster 1 (A high) state to their cluster 2 (B high) state under clamping, even with no noise applied. In larger and more complex circuits, it may be necessary to clamp multiple genes or combine clamping with noise to enable state transitions across an ensemble. 


```{r clamp_plots}
library(ggplot2)                 # plotting

# plot initial & final states from clamping
ics_raw <- as.data.frame(t(sracipeIC(racipe_bistable)))
ics_norm <- log2(1+ics_raw)
ics_norm[,genes] <- sweep(ics_norm[,genes], 2, tmpMeans, FUN = "-") # scale
ics_norm[,genes] <- sweep(ics_norm[,genes], 2, tmpSds, FUN = "/") # scale
ics_pca <- as.data.frame(as.matrix(ics_norm[, c(1, 2)]) %*% pca$rotation)
ics_norm$Time <- "Initial"

final_states_raw <- as.data.frame(t(assay(racipe_clamp_relax)))
final_states_norm <- log2(1+final_states_raw)
final_states_norm[,genes] <- sweep(final_states_norm[,genes], 2, tmpMeans, FUN = "-") # scale
final_states_norm[,genes] <- sweep(final_states_norm[,genes], 2, tmpSds, FUN = "/") # scale
final_states_pca <- as.data.frame(as.matrix(final_states_norm[, c(1, 2)]) %*% pca$rotation)
final_states_norm$Time <- "Final"


states_comb <- rbind(ics_norm, final_states_norm)


ggplot2::ggplot(states_comb,aes(x=A, y=B, color=Time)) +
  geom_point(alpha=0.6, size=3) +
  labs(x = "A", y = "B", color="Time") +
  theme_minimal() +
  theme(axis.text = element_text(size=24),
        axis.title = element_text(size=28),)



```


